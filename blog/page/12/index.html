
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>James Smith</title>
  <meta name="author" content="James Smith">

  
  <meta name="description" content="James Smith Building a better future out of code or§dinal Comments Gems, Bookmarks, and Sandwiches I&#8217;ve been crazy busy for a while, but what &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://floppy.org.uk/blog/page/12">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="James Smith" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/custom.css" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2310810-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/">Home</a></li>
    
        <li ><a href="/blog/archives">Archive</a></li>
    
        <li ><a href="/code">Code</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="mailto:james@floppy.org.uk" title="Email"><i class="icon-envelope-alt social-navbar"></i></a></li>
    
    
    <li><a href="http://github.com/Floppy" title="Github Profile"><i class="icon-github social-navbar"></i></a></li>
    
    
    
    <li><a href="http://twitter.com/floppy" title="Twitter Profile"><i class="icon-twitter social-navbar"></i></a></li>
    
    
    <li><a href="http://plus.google.com/106927026319199661821" title="Google+ Profile"><i class="icon-google-plus social-navbar"></i></a></li>
    
    
    <li><a href="http://floppy.org.uk/atom.xml" title="Subscribe"><i class="icon-rss social-navbar"></i></a></li>
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <div class="jumbotron">
  <div class="container">
    James Smith
    <h3 class="tagline">Building a better future out of code</h3>
  </div>
</div>


<div class="blog-index">
  
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2">
		<h1 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2008-10-13T00:00:00+01:00" pubdate data-updated="true">or§dinal</time></h5>
          <div class="row-fluid">
          
          <a href="http://floppy.org.uk/blog/2008/10/13/gems-bookmarks-and-sandwiches/#disqus_thread">Comments </a> <span class="fui-bubble-16"></span>
          
          </div>
          
          <div class="row-fluid">
          
          </div>
          
    </div>
    <div class="span10">
      <h1 class="link"><a href="/blog/2008/10/13/gems-bookmarks-and-sandwiches/">Gems, Bookmarks, and Sandwiches</a></h1>
      <p>
I&#8217;ve been crazy busy for a while, but what little spare time I have grabbed here and there has been used investigating some areas of Rails I hadn&#8217;t played with before, like route globbing and running without a database. The results are a couple of tools, one useful, one most definitely not.
</p>

<p><img src="http://img.skitch.com/20081010-dy86i2ny1rbu91b995nt6r5hrj.png" style="float:right"/></p>

<p>
The first (and most useful) is <a href="http://hasmygembuiltyet.org">Has My Gem Built Yet?</a>. I have a bunch of ruby gems on GitHub and get annoyed that I have to keep running &#8220;gem update&#8221; while waiting for GitHub to build the gem once I&#8217;ve pushed the code. Well, no more. Just put in the details, and the page checks for you and pops up a message when the gem is done. Nice. It got picked up on <a href="http://github.com/blog/177-has-my-gem-built-yet">the GitHub blog</a>, and I&#8217;ve even had some patches sent in. It&#8217;s a nice feeling :)
</p>

<p>
The second app is somewhat less useful (though still entertaining). After a suggestion on Twitter by <a href="http://tomtaylor.co.uk">Tom Taylor</a>, I built a website which lets you bookmark <a href="http://s.andwi.ch">sandwich</a> combinations. There are a couple of interesting bits in this though - first is route globbing, which is the Rails way of using arbitrary bits of the URL as parameters to an action. Not something you use in every project, but still. More importantly, I&#8217;ve used it to test out <a href="http://github.com/Floppy/rubymarks">rubymarks</a>, a Rails plugin for generating links for social bookmarking services.
</p>

<p>
I love Rails for this sort of thing. I can&#8217;t think of other system I&#8217;ve used that would let me create such fun things in the tiny snippets of spare time I have at the moment. And of course, everything above is open source and available on <a href="http://github.com/Floppy">Github</a>.
</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2">
		<h1 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2008-08-31T00:00:00+01:00" pubdate data-updated="true">or§dinal</time></h5>
          <div class="row-fluid">
          
          <a href="http://floppy.org.uk/blog/2008/08/31/mocking-kernelrequire/#disqus_thread">Comments </a> <span class="fui-bubble-16"></span>
          
          </div>
          
          <div class="row-fluid">
          
          </div>
          
    </div>
    <div class="span10">
      <h1 class="link"><a href="/blog/2008/08/31/mocking-kernelrequire/">Mocking Kernel#require</a></h1>
      <p>
The other day, I remembered to add coverage analysis to my <a href="http://github.com/Floppy/amee-ruby">AMEE-Ruby</a> tests, using <a href="http://">rcov</a>. The results were pretty good - most of the code was already tested, except a few failure cases, and I quickly wrote some new tests to make sure those were working properly. One little bit of code stood out though. Because AMEE talks XML and JSON, my gem can use JSON, but only if the JSON gem is available on the system (XML support is built into core Ruby). Problem is, require calls throw errors if they fail, so I had to write some code to handle the load failure and carry on regardless. This is the code inside amee.rb:
</p>

<p>
<code lang="ruby" theme="zenburnesque">
begin
  require 'json'
rescue LoadError
  nil
end
</code>
</p>

<p>
Problem with this is that the gem is installed on my system, so the require never fails, and the rescue is never used. Rcov notices, and I can&#8217;t get to 100% coverage, which is <em>annoying</em>.
</p>

<p>
So, mocking to the rescue. We have to make Kernel#rescue throw an error if we try to require &#8216;json&#8217;, even if the gem is installed. At first, I tried to use flexmock to do this, but couldn&#8217;t make it work - if anyone knows how, <em>please</em> tell me. My final approach was to monkeypatch Kernel#require inside my test so that require &#8216;json&#8217; (and only json) would fail:
</p>

<p>
<code lang="ruby" theme="zenburnesque">
it "should cope if json gem isn't available" do
  # Monkeypatch Kernel#require to make sure that require 'json'
  # raises a LoadError
  module Kernel
    def require_with_mock(string)
      raise LoadError.new if string == 'json' 
      require_without_mock(string)
    end
    alias_method :require_without_mock, :require 
    alias_method :require, :require_with_mock
  end
  # Remove amee.rb from required file list so we can load it again
  $".delete_if{|x| x.include? 'amee.rb'}
  # Require file - require 'json' should throw a LoadError,
  # but we should cope with it OK.
  lambda {
    require 'amee'
  }.should_not raise_error
end
</code>
</p>

<p>
We have to make a new require function, then use alias_method to rename the old one and install our new one in it&#8217;s place. Rails includes alias_method_chain to make this easier, but that&#8217;s not available in pure Ruby. Never mind. Once we&#8217;ve done the monkeypatch, we take amee.rb out of the $&#8221; array, which lists all the currently-required files, to make sure we can require it again, then simply run the require and make sure it catches the error that is thrown by our patched require. And the most satisfying part? The rescue is executed, the test works, and we get to 100% coverage. I&#8217;ve got a nice warm fuzzy feeling inside&#8230; mmmmmm.
</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2">
		<h1 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2008-08-29T00:00:00+01:00" pubdate data-updated="true">or§dinal</time></h5>
          <div class="row-fluid">
          
          <a href="http://floppy.org.uk/blog/2008/08/29/currentcost-data-live-on-pachube/#disqus_thread">Comments </a> <span class="fui-bubble-16"></span>
          
          </div>
          
          <div class="row-fluid">
          
          </div>
          
    </div>
    <div class="span10">
      <h1 class="link"><a href="/blog/2008/08/29/currentcost-data-live-on-pachube/">CurrentCost data live on Pachube</a></h1>
      <p>
So, the other day I got a nice little <a href="http://">tray icon</a> working for my CurrentCost power monitor. That&#8217;s great, but data is only really gets fun when it&#8217;s mashable, so the next step was to get it online somehow.
</p>

<p>
<a href="http://pachube.com">Pachube</a> is a site which aggregates data feeds from real-world (and virtual-world) devices, shows them on a map, makes graphs, things like that, so it seemed like a good first attempt at putting my power data online. My first thought was to get my app to post data at regular intervals to the service, but unfortunately Pachube doesn&#8217;t work like that. Instead, it acts more like a news reader, not a publishing platform - Google Reader instead of Blogger, if that makes sense. So, I had to publish my feed live on the web and point Pachube at the URL.
</p>

<p>
First step: EEML. This is an XML-based format which Pachube reads which can contain not only multiple data feeds, but tags and other metadata. So (as seems to be the fashion), I wrapped it up in a Ruby gem, <a href="http://github.com/Floppy/eeml-ruby/tree/master">available from GitHub</a> as ever. The gem simply provides utility classes to build an EEML feed and convert it to the XML-based format for delivery over the web.
</p>

<p>
Then, the final step was to publish the data on the web. For that, we need a web server. However, having a full web server for just one feed seemed overkill, and I didn&#8217;t want to publish to yet another intermediate server, so we need to serve the data directly. Ruby to the rescue once again. WEBrick is a simple web server which is part of the core Ruby libraries. You create a server, write simple servlet classes, and mount them at particular locations. For instance:
</p>

<p>
<code lang="ruby_on_rails" theme="zenburnesque">
# Create WEBrick server
s = WEBrick::HTTPServer.new( :Port =&gt; 50000 )
# A simple "hello world" servlet 
class HelloServlet 
</code></p>

<p>
Now, http://localhost:50000/ will say &#8220;hello world&#8221;. From here it&#8217;s a simple modification to publish the EEML feed. EEML-Ruby includes a <a href="http://github.com/Floppy/eeml-ruby/tree/master/examples/simple_server.rb">simple EEML server script</a> as an example. So, after building this into the tray app, now whenever my CurrentCost is connected and the app is running, it serves up EEML data to the web. You can see the data feed (fairly intermittent, as obviously the meter isn&#8217;t always connected to my PC at the moment) <a href="http://pachube.com/feeds/488">live on Pachube</a>.
</p>

      
      
    </div>
  </div>



    </article>
    
  
  <div class="pagination">
    
    <a class="prev" href="/blog/page/13/">&larr; Older</a>
    

    
    <a class="next" href="/blog/page/11/">Newer &rarr;</a>
    
  </div>
</div>


        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2014 - James Smith -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>
</p>


        </footer>
      </div>
    </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'floppyorguk';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
